<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Discord Chat Archive Reader</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
      :root{ --bg:#0f1012; --card:#16171a; --muted:#98a0b3; --accent:#5865f2; }
      *{ box-sizing: border-box; }
      html,body{ height:100%; margin:0; font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; background: linear-gradient(180deg,#080808 0%, #0f1012 60%); color:#e6eef8; overflow-x: hidden; }
      .app{ min-height:100vh; display:flex; align-items:flex-start; justify-content:center; padding:36px }
      .container{ width:100%; max-width:1000px; display:grid; grid-template-columns: 360px 1fr; gap:20px; align-items:start }
      .sidebar{ background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; box-shadow: 0 6px 24px rgba(3,6,12,0.6); }
      .main{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:12px; padding:18px; box-shadow: 0 6px 24px rgba(3,6,12,0.6); display:flex; flex-direction:column; max-height: calc(100vh - 120px); }
      h1{ font-size:18px; margin:0 0 10px 0; font-weight:600 }
      .controls{ display:flex; gap:8px; align-items:center; margin-bottom:12px }
      .file-btn, .ghost-btn{ background:var(--accent); color:white; border:none; padding:10px 12px; border-radius:8px; cursor:pointer; font-weight:600 }
      .ghost-btn{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); font-weight:500 }
      .search{ flex:1; padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:transparent; color:inherit }
      #messages{ overflow:auto; border-radius:8px; padding:8px; background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.01)); flex:1; max-height: calc(100vh - 200px); }
      .message{ display:flex; gap:12px; padding:12px; border-radius:10px; align-items:flex-start; transition:background 120ms; max-width:100%; }
      .message:hover{ background:rgba(255,255,255,0.015) }
      .avatar{ width:48px; height:48px; border-radius:12px; background:#111; object-fit:cover; flex-shrink:0 }
      .meta{ display:flex; gap:8px; align-items:center; margin-bottom:6px }
      .author{ font-weight:600; color:#fff }
      .timestamp{ color:var(--muted); font-size:12px }
      .text{ color:#dbe9ff; line-height:1.35; overflow-wrap:anywhere; word-break:break-word; }
      .attachments{ display:flex; gap:8px; margin-top:8px; flex-wrap:wrap }
      .attachment{ width:140px; height:96px; object-fit:cover; border-radius:8px; cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,0.5) }
      .empty{ color:var(--muted); padding:40px; text-align:center }
      .footer{ text-align:center; color:var(--muted); font-size:13px; padding-top:8px }

      /* modal */
      .modal-backdrop{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(6,7,8,0.8); backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px); z-index:2000 }
      /* Fancy alert */
      .fancy-alert-backdrop{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.75); backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); z-index:3000 }
      .fancy-alert{ width:420px; max-width:92%; background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02)); border-radius:12px; padding:18px; box-shadow:0 12px 40px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.04); animation: alertIn 240ms ease both }
      .fancy-alert h3{ margin:0 0 8px 0; font-size:16px }
      .fancy-alert p{ margin:0 0 12px 0; color:var(--muted) }
      .fancy-alert .actions{ display:flex; justify-content:flex-end; gap:8px }
      .fancy-alert .btn{ padding:8px 12px; border-radius:8px; cursor:pointer; border:none }
      .fancy-alert .btn.primary{ background:var(--accent); color:#fff }
      .fancy-alert .btn.ghost{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted) }
      @keyframes alertIn{ from{ transform: translateY(12px) scale(.98); opacity:0 } to{ transform: translateY(0) scale(1); opacity:1 } }
      .modal-backdrop.show{ display:flex }
      .modal-card{ max-width:90%; max-height:85%; border-radius:12px; overflow:auto }
      .modal-img{ max-width:100%; height:auto; display:block; border-radius:8px }

      /* Profile Modal */
      .profile-modal{ width:360px; max-width:90%; background:linear-gradient(180deg, #1a1b1e, #16171a); border-radius:12px; box-shadow:0 12px 40px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.04); animation: alertIn 240ms ease both; color: #fff; text-align: left; }
      .profile-header{ height: 90px; background-size: cover; background-position: center; border-radius: 11px 11px 0 0; background-color: #333; }
      .profile-avatar-wrapper{ height: 44px; }
      .profile-avatar{ width: 88px; height: 88px; border-radius: 50%; border: 4px solid #16171a; margin-top: -44px; margin-left: 16px; background: #16171a; object-fit: cover; }
      .profile-body{ padding: 16px; padding-top: 12px; }
      .profile-name{ font-size: 20px; font-weight: 700; margin: 0; line-height: 1; }
      .profile-discriminator{ color: var(--muted); }
      .profile-badges { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
      .profile-badge { height: 22px; }
      .profile-status { display: flex; align-items: center; gap: 8px; margin-top: 12px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; font-size: 14px; }
      .status-dot { width: 12px; height: 12px; border-radius: 50%; flex-shrink: 0; }
      .status-dot.online { background: #3ba55d; }
      .status-dot.idle { background: #faa61a; }
      .status-dot.dnd { background: #ed4245; }
      .status-dot.offline { background: #747f8d; }
      .profile-activities { margin-top: 12px; display: flex; flex-direction: column; gap: 10px; }
      .activity { display: flex; align-items: center; gap: 10px; padding: 10px; background: rgba(0,0,0,0.2); border-radius: 8px; }
      .activity img { width: 40px; height: 40px; border-radius: 8px; }
      .activity-details { font-size: 14px; overflow: hidden; }
      .activity-details strong { display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .activity-details span { color: var(--muted); font-size: 12px; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .loading-profile { padding: 40px; text-align: center; color: var(--muted); }
      .reply{ background:rgba(255,255,255,0.02); padding:8px 12px; border-radius:8px; margin-bottom:8px; border-left: 2px solid var(--accent); font-size: 14px; }
      .reply-author{ font-weight: 600; }

      /* Custom scrollbar */
      #messages::-webkit-scrollbar { width: 8px; }
      #messages::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 4px; }
      #messages::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 4px; }
      #messages::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.12); }

      @media (max-width:820px){ .container{ grid-template-columns: 1fr; } .sidebar{ order:2 } }

      /* Fancy page mode (easter egg) */
      @keyframes bgMove {
        0% { background-position: 0% 50%; }
        50% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      body.fancy-mode {
        background: linear-gradient(120deg, #0b1020, #0e0720, #071022, #07121a);
        background-size: 400% 400%;
        animation: bgMove 12s ease infinite;
      }
      body.fancy-mode .container{
        box-shadow: 0 24px 80px rgba(88,101,242,0.12), inset 0 0 60px rgba(88,101,242,0.04);
        border-radius:14px;
        border: 1px solid rgba(88,101,242,0.12);
        animation: borderPulse 3s ease-in-out infinite;
      }
      body.fancy-mode .sidebar, body.fancy-mode .main{
        border-radius:14px;
        box-shadow: 0 12px 50px rgba(3,6,12,0.6), 0 0 30px rgba(88,101,242,0.03) inset;
        transition: box-shadow 400ms;
      }
      body.fancy-mode .message{ transform-origin:left center; animation: floatMsg 6s ease-in-out infinite }
      @keyframes floatMsg { 0%{ transform: translateY(0)} 50%{ transform: translateY(-6px)} 100%{ transform: translateY(0)} }
      body.fancy-mode .avatar{ box-shadow: 0 6px 18px rgba(88,101,242,0.14); border-radius:12px }
      /* subtle animated border glow */
      body.fancy-mode .container::before{ content:''; position:absolute; inset:-2px; background:linear-gradient(90deg, rgba(88,101,242,0.18), rgba(60,200,180,0.12), rgba(88,101,242,0.18)); filter:blur(18px); z-index:-1; border-radius:16px; opacity:0.95; animation: bgMove 10s linear infinite }

      @keyframes borderPulse {
        0% {
          box-shadow: 0 24px 60px rgba(88,101,242,0.06), inset 0 0 30px rgba(88,101,242,0.02);
          border-color: rgba(88,101,242,0.08);
        }
        50% {
          box-shadow: 0 30px 100px rgba(88,101,242,0.18), inset 0 0 80px rgba(88,101,242,0.06);
          border-color: rgba(60,200,180,0.16);
        }
        100% {
          box-shadow: 0 24px 60px rgba(88,101,242,0.06), inset 0 0 30px rgba(88,101,242,0.02);
          border-color: rgba(88,101,242,0.08);
        }
      }

      /* pulse inner panels too */
      body.fancy-mode .sidebar, body.fancy-mode .main{ animation: innerPulse 3s ease-in-out infinite }
      @keyframes innerPulse {
        0% { box-shadow: 0 12px 50px rgba(3,6,12,0.6), 0 0 8px rgba(88,101,242,0.02) inset; }
        50% { box-shadow: 0 18px 70px rgba(3,6,12,0.6), 0 0 30px rgba(88,101,242,0.06) inset; }
        100% { box-shadow: 0 12px 50px rgba(3,6,12,0.6), 0 0 8px rgba(88,101,242,0.02) inset; }
      }
    </style>
  </head>
  <body>
    <div id="root" class="app"></div>

    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>

    <script type="text/babel">
      const { useState, useRef, useEffect } = React;

      function formatDate(ts){
        try {
          let timestamp = ts;
          // If it's a numeric string, convert it to a number.
          if (typeof ts === 'string' && /^\d+$/.test(ts)) {
            timestamp = Number(ts);
          }

          if (typeof timestamp === 'number') {
            // Heuristic to check if it's seconds or milliseconds.
            // If timestamp * 1000 is closer to now than timestamp, it's likely in seconds.
            const now = Date.now();
            if (Math.abs(now - timestamp) > Math.abs(now - timestamp * 1000)) {
              timestamp = timestamp * 1000;
            }
          }
          
          const date = new Date(timestamp);
          if (isNaN(date.getTime())) return ts; // Invalid date
          
          return date.toLocaleString();
        } catch(e) {
          return ts;
        }
      }

      // Helpers to resolve user IDs and normalize names across varying JSON shapes
      function normalizeName(n){ return (n || '').trim().toLowerCase(); }
      function extractIdFromUrl(u){
        if(!u) return null;
        try{
          const s = String(u);
          const m = s.match(/\/(?:avatars|users|profiles)\/(\d{16,25})/);
          return m ? m[1] : null;
        }catch(e){ return null }
      }
      function coalesce(){
        for (let i=0;i<arguments.length;i++){
          const v = arguments[i];
          if (v !== undefined && v !== null && String(v).length > 0) return v;
        }
        return null;
      }
      function resolveIdFromObject(obj){
        if(!obj || typeof obj !== 'object') return null;
        return coalesce(
          obj.id, obj.user_id, obj.userId, obj.author_id, obj.authorId,
          extractIdFromUrl(obj.avatar), extractIdFromUrl(obj.icon), extractIdFromUrl(obj.icon_url), extractIdFromUrl(obj.avatar_url)
        );
      }
      function generateNameKeys(name){
        const base = normalizeName(name);
        const keys = new Set([base]);
        // drop trailing colon
        keys.add(base.replace(/:$/, ''));
        // remove whitespace variant
        keys.add(base.replace(/\s+/g, ''));
        // remove non-alphanumerics variant
        keys.add(base.replace(/[^a-z0-9]/g, ''));
        // discriminator style name#1234 -> name
        if (base.includes('#')) keys.add(base.split('#')[0]);
        // dotted style name.suffix -> name
        if (base.includes('.')) keys.add(base.split('.')[0]);
        return Array.from(keys);
      }
      function resolveIdByName(map, name){
        if (!name) return null;
        const keys = generateNameKeys(name);
        for (let i=0;i<keys.length;i++){
          const k = keys[i];
          if (map[k]) return map[k];
        }
        return null;
      }

      const badgeInfo = {
        Discord_Employee: { icon: 'https://cdn.discordapp.com/badge-icons/5e74e9b61934fc1f67c65515d1f7e60d.png', label: 'Discord Employee' },
        HypeSquad_Events: { icon: 'https://cdn.discordapp.com/badge-icons/bf01d1073931f921909045f3a39fd264.png', label: 'HypeSquad Events' },
        Bug_Hunter_Level_1: { icon: 'https://cdn.discordapp.com/badge-icons/2717692c7dca7289b35297368a940dd0.png', label: 'Bug Hunter' },
        House_Bravery: { icon: 'https://cdn.discordapp.com/badge-icons/8a88d63823d8a71cd5e390baa45efa02.png', label: 'HypeSquad Bravery' },
        House_Brilliance: { icon: 'https://cdn.discordapp.com/badge-icons/011940fd013da3f7fb926e4a1cd2e618.png', label: 'HypeSquad Brilliance' },
        House_Balance: { icon: 'https://cdn.discordapp.com/badge-icons/3aa41de486fa12454c3761e8e223442e.png', label: 'HypeSquad Balance' },
        Early_Supporter: { icon: 'https://cdn.discordapp.com/badge-icons/7060786766c9c840eb3019e725d2b358.png', label: 'Early Supporter' },
        Bug_Hunter_Level_2: { icon: 'https://cdn.discordapp.com/badge-icons/848f79194d4be5ff5f81505cbd0ce1e6.png', label: 'Bug Hunter Level 2' },
        Verified_Bot: { icon: 'https://raw.githubusercontent.com/discordjs/site/main/public/images/badges/verified-bot.svg', label: 'Verified Bot' },
        Verified_Developer: { icon: 'https://cdn.discordapp.com/badge-icons/6df5892e0f35b051f8b61eace34f4967.png', label: 'Verified Bot Developer' },
        Certified_Moderator: { icon: 'https://cdn.discordapp.com/badge-icons/fee1624003e2fee35cb398e125dc479b.png', label: 'Certified Moderator' },
        Active_Developer: { icon: 'https://cdn.discordapp.com/badge-icons/6bdc42827a38498929a4920da12695d9.png', label: 'Active Developer' }
      };

      function App(){
        const [messages, setMessages] = useState([]);
        const [filter, setFilter] = useState('');
        const [modalSrc, setModalSrc] = useState(null);
        const [showImportModal, setShowImportModal] = useState(false);
        const [urlInput, setUrlInput] = useState('');
        const [alert, setAlert] = useState(null); // {title, message}
        const [profileUser, setProfileUser] = useState(null);
        const [profileData, setProfileData] = useState(null);
        const [loadingProfile, setLoadingProfile] = useState(false);
        const fileInputRef = useRef();
        const nameIdRef = useRef({});

        useEffect(()=>{
          const map = {};
          messages.forEach(function(mm){
            const id = coalesce(
              resolveIdFromObject(mm.author),
              resolveIdFromObject(mm.user),
              mm.user_id, mm.userId, mm.author_id, mm.authorId
            );
            const name = coalesce(
              mm.author && (mm.author.display_name || mm.author.name || mm.author.username),
              mm.user && (mm.user.display_name || mm.user.name || mm.user.username),
              mm.display_name, mm.username, mm.name
            );
            if (id && name) {
              generateNameKeys(name).forEach(function(k){ if (!map[k]) map[k] = String(id); });
            }
            if (mm.reply) {
              const rid = coalesce(
                resolveIdFromObject(mm.reply.author),
                resolveIdFromObject(mm.reply.user),
                mm.reply.user_id, mm.reply.userId, mm.reply.id, mm.reply.author_id, mm.reply.authorId
              );
              const rname = coalesce(
                mm.reply.author && (mm.reply.author.display_name || mm.reply.author.name || mm.reply.author.username),
                mm.reply.user && (mm.reply.user.display_name || mm.reply.user.name || mm.reply.user.username),
                mm.reply.display_name, mm.reply.username, mm.reply.name
              );
              if (rid && rname) {
                generateNameKeys(rname).forEach(function(k){ if (!map[k]) map[k] = String(rid); });
              }
            }
          });
          nameIdRef.current = map;
        }, [messages]);

        function openFile(){ setShowImportModal(true); }

        function onFile(e){
          const f = e.target.files && e.target.files[0];
          if(!f) return;
          const r = new FileReader();
          r.onload = (ev) => {
            try{
              const data = JSON.parse(ev.target.result);
              // normalize to array of messages
              let newMessages = [];
              if (Array.isArray(data)) {
                newMessages = data;
              } else if (data.messages) {
                newMessages = data.messages;
              } else if (data.content && data.id) {
                // It's the new single message format, wrap it in an array
                newMessages = [data];
              }
              setMessages(newMessages);
            }catch(err){ alert('Invalid JSON file') }
          // if import modal was open, close it after file chosen
          setShowImportModal(false);
          };
          r.readAsText(f);
        }

        async function handleUrlImport() {
          if (!urlInput) return alert('Enter a URL');
          try {
            const res = await fetch(urlInput);
            if (!res.ok) throw new Error('Network response was not ok');
            const data = await res.json();
            let newMessages = [];
            if (Array.isArray(data)) {
              newMessages = data;
            } else if (data.messages) {
              newMessages = data.messages;
            } else if (data.content && data.id) {
              // It's the new single message format, wrap it in an array
              newMessages = [data];
            }
            setMessages(newMessages);
            setShowImportModal(false);
            setUrlInput('');
          } catch (err) {
            console.error(err);
            setAlert({ title: 'Fetch error', message: 'Failed to fetch or parse JSON from URL' });
          }
        }
        
        async function showProfile(user) {
          if (!user) return;
          // Accept either a userId (string/number) or an object like { id?, username? }
          if (typeof user === 'object') {
            const fallbackName = user.username || user.name || 'Unknown';
            const fallbackId = user.id || null;
            setProfileUser(fallbackName);
            setProfileData({ failed: true, discord_user: { id: fallbackId }, fallbackName });
            return;
          }

          const userId = String(user);
          setProfileUser(userId);
          if (profileData && profileData.discord_user && profileData.discord_user.id === userId && !profileData.failed) {
            return; // Already loaded this profile
          }

          setLoadingProfile(true);
          setProfileData(null);
          try {
            const res = await fetch(`https://discordlookup.mesalytic.moe/v1/user/${userId}`);
            if (!res.ok) {
              const errorData = await res.json().catch(() => ({}));
              throw new Error((errorData && errorData.message) || `User not found (${res.status})`);
            }
            const data = await res.json();

            // Map the new API response to the structure expected by ProfileView
            const mapped = {
              discord_user: {
                id: data.id,
                username: data.username,
                discriminator: data.raw && data.raw.discriminator ? data.raw.discriminator : '0',
                avatar: data.avatar ? data.avatar.link : null,
                banner: data.banner ? data.banner.link : null,
                display_name: data.global_name || data.username,
                banner_color: data.banner ? data.banner.color : (data.accent_color ? `#${data.accent_color.toString(16).padStart(6, '0')}` : null)
              },
              // This new API does not provide presence data (status, activities)
              discord_status: 'offline',
              activities: [],
              spotify: null,
              // Pass the new badges array directly
              badges: data.badges || []
            };
            setProfileData(mapped);

          } catch (err) {
            console.error(err);
            setAlert({ title: 'Profile Error', message: `Could not fetch profile for user ${userId}. Reason: ${err.message}` });
            setProfileData({ failed: true, discord_user: { id: userId } });
          } finally {
            setLoadingProfile(false);
          }
        }


        function renderMessage(m, i){
          const hasAttachments = m.attachments && m.attachments.length;
          if(filter && !(m.content || '').toLowerCase().includes(filter.toLowerCase()) && !(m.author && m.author.name && m.author.name.toLowerCase().includes(filter.toLowerCase()))) return null;
          
          const authorId = coalesce(
            resolveIdFromObject(m.author),
            resolveIdFromObject(m.user),
            m.user_id, m.userId, m.author_id, m.authorId
          );
          const authorName = coalesce(
            m.author && (m.author.display_name || m.author.name || m.author.username),
            m.user && (m.user.display_name || m.user.name || m.user.username),
            m.display_name, m.username, m.name, 'Unknown'
          );
          const authorDiscriminator = (m.author && m.author.discriminator) || (m.user && m.user.discriminator);
 
          const replyAuthorId = m.reply ? coalesce(
            resolveIdFromObject(m.reply.author),
            resolveIdFromObject(m.reply.user),
            m.reply && (m.reply.user_id || m.reply.userId || m.reply.id || m.reply.author_id || m.reply.authorId)
          ) : null;
          const replyAuthorName = m.reply ? coalesce(
            m.reply.author && (m.reply.author.display_name || m.reply.author.name || m.reply.author.username),
            m.reply.user && (m.reply.user.display_name || m.reply.user.name || m.reply.user.username),
            m.reply.display_name, m.reply.username, m.reply.name
          ) : null;
 
          return (
            <div className="message" key={m.id || i}>
              <img className="avatar" src={(m.author && m.author.avatar) ? m.author.avatar : 'https://cdn.discordapp.com/embed/avatars/0.png'} alt="avatar" />
              <div style={{flex:1}}>
                <div className="meta">
                  <div>
                    <div className="author" title="View profile" style={{cursor: 'pointer'}} onClick={()=> {
                      const resolved = authorId || resolveIdByName(nameIdRef.current, authorName);
                      showProfile(resolved || { username: authorName })
                    }}>
                        {authorName}
                        {authorDiscriminator && authorDiscriminator != "0" && <span className="discriminator">#{authorDiscriminator}</span>}
                     </div>
                     <div className="timestamp">{formatDate(m.timestamp)}</div>
                   </div>
                </div>
                {m.reply && (
                  <div className="reply">
                    <span className="reply-author" title="View profile" style={{cursor: 'pointer'}} onClick={() => {
                      const resolved = replyAuthorId || (replyAuthorName ? resolveIdByName(nameIdRef.current, replyAuthorName) : null);
                      showProfile(resolved || { username: replyAuthorName })
                    }}>{replyAuthorName}</span>: {m.reply.content}
                  </div>
                )}
                <div className="text">{m.content || ''}</div>
                {hasAttachments ? (
                  <div className="attachments">
                    {m.attachments.map((a,idx)=> (
                      <img key={idx} className="attachment" src={a} onClick={()=>setModalSrc(a)} alt="attachment" />
                    ))}
                  </div>
                ) : null}
              </div>
            </div>
          )
        }

        // easter egg: clear click tracker
        const clearTrackerRef = React.useRef({ count:0, last:0, timer:null });
        const fancyRef = React.useRef({ enabled:false, raf: null, canvas: null, particles: [] });

        function startFancy() {
          if (fancyRef.current.enabled) return;
          fancyRef.current.enabled = true;
          document.body.classList.add('fancy-mode');
          // create canvas overlay for particles
          const canvas = document.createElement('canvas');
          canvas.id = 'fancy-canvas';
          canvas.style.position = 'fixed';
          canvas.style.top = '0';
          canvas.style.left = '0';
          canvas.style.width = '100%';
          canvas.style.height = '100%';
          canvas.style.pointerEvents = 'none';
          canvas.style.zIndex = '2500';
          document.body.appendChild(canvas);
          fancyRef.current.canvas = canvas;
          const ctx = canvas.getContext('2d');

          function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
          }
          resize();
          window.addEventListener('resize', resize);

          // create particles
          const particles = [];
          const colours = ['rgba(88,101,242,0.9)', 'rgba(60,200,180,0.9)', 'rgba(255,120,120,0.9)'];
          for (let i=0;i<80;i++){
            particles.push({
              x: Math.random()*canvas.width,
              y: Math.random()*canvas.height,
              r: 1 + Math.random()*3,
              vx: (Math.random()-0.5)*0.6,
              vy: (Math.random()-0.5)*0.6,
              c: colours[Math.floor(Math.random()*colours.length)],
              alpha: 0.2 + Math.random()*0.6
            });
          }
          fancyRef.current.particles = particles;

          function tick(){
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particles.forEach(p=>{
              p.x += p.vx; p.y += p.vy;
              if (p.x < -10) p.x = canvas.width+10;
              if (p.x > canvas.width+10) p.x = -10;
              if (p.y < -10) p.y = canvas.height+10;
              if (p.y > canvas.height+10) p.y = -10;
              ctx.beginPath();
              ctx.fillStyle = p.c.replace('0.9', p.alpha.toFixed(2));
              ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
              ctx.fill();
            });
            fancyRef.current.raf = requestAnimationFrame(tick);
          }
          fancyRef.current.raf = requestAnimationFrame(tick);
          // attach resize remover
          fancyRef.current._onResize = resize;
        }

        function stopFancy() {
          if (!fancyRef.current.enabled) return;
          fancyRef.current.enabled = false;
          document.body.classList.remove('fancy-mode');
          // stop animation and remove canvas
          if (fancyRef.current.raf) cancelAnimationFrame(fancyRef.current.raf);
          if (fancyRef.current.canvas) {
            window.removeEventListener('resize', fancyRef.current._onResize);
            try { fancyRef.current.canvas.remove(); } catch(e) {}
            fancyRef.current.canvas = null;
          }
          fancyRef.current.particles = [];
        }

        function handleClearClick(){
          const now = Date.now();
          const st = clearTrackerRef.current;
          if (now - st.last > 5000) { st.count = 0; }
          st.count++;
          st.last = now;
          if (st.timer) clearTimeout(st.timer);
          st.timer = setTimeout(()=>{ st.count = 0 }, 5000);
          setMessages([]);
          // trigger fancy mode if 5 clicks within 5s
          if (st.count >=5) {
            if (fancyRef.current.enabled) {
              stopFancy();
              setAlert({ title: 'Fancy mode disabled', message: 'Easter egg turned off.' });
            } else {
              startFancy();
              setAlert({ title: 'Easter Egg!', message: 'Fancy mode activated ✨' });
            }
            st.count = 0;
          }
        }

        return (
          <div className="container">
              <div className="sidebar">
              <h1>Discord Chat Archive</h1>
                <div style={{display:'flex',gap:8, marginBottom:12}}>
                <button className="file-btn" onClick={openFile}>Import JSON</button>
                <button className="ghost-btn" onClick={handleClearClick}>Clear</button>
              </div>
              <input ref={fileInputRef} type="file" accept="application/json" style={{display:'none'}} onChange={onFile} />
              {/* Import Modal */}
              {showImportModal && (
                <div style={{marginTop:8, padding:12, background:'rgba(0,0,0,0.4)', borderRadius:8}}>
                  <div style={{marginBottom:8}}>Choose import method:</div>
                  <div style={{display:'flex', gap:8}}>
                    <button className="file-btn" onClick={()=>{ fileInputRef.current.click(); }}>From file</button>
                    <div style={{flex:1}}>
                      <input className="search" placeholder="Enter JSON URL..." value={urlInput} onChange={e=>setUrlInput(e.target.value)} />
                      <div style={{display:'flex', gap:8, marginTop:8}}>
                        <button className="file-btn" onClick={handleUrlImport}>Import from URL</button>
                        <button className="ghost-btn" onClick={()=>{ setShowImportModal(false); setUrlInput(''); }}>Cancel</button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              <p style={{color:'var(--muted)', marginTop:6}}>Tip: export Discord JSON or use a channel export. Click attachments to preview.</p>
              <div style={{height:16}}></div>
              <div style={{borderTop:'1px solid rgba(255,255,255,0.02)', paddingTop:12}}>
                <div style={{fontSize:13, color:'var(--muted)', marginBottom:8}}>Messages: <strong style={{color:'#fff'}}>{messages.length}</strong></div>
                <div className="footer">Built with ❤️ by MilitaryLotus</div>
              </div>
            </div>

            <div className="main">
              <div className="controls">
                <input placeholder="Search messages or authors..." className="search" value={filter} onChange={e=>setFilter(e.target.value)} />
                <button className="ghost-btn" onClick={()=>{ setFilter('') }}>Reset</button>
              </div>
              <div id="messages">
                {messages.length === 0 ? (<div className="empty">No messages loaded. Click "Import JSON" to get started.</div>) : messages.map((m,i)=> renderMessage(m,i))}
              </div>
            </div>

            <div className={"modal-backdrop " + (modalSrc ? 'show' : '')} onClick={()=>setModalSrc(null)}>
              {modalSrc && (
                <div className="modal-card" onClick={e=>e.stopPropagation()}>
                  <img className="modal-img" src={modalSrc} alt="preview" />
                </div>
              )}
            </div>

            {profileUser && (
              <div className="modal-backdrop show" onClick={()=>setProfileUser(null)}>
                <div className="modal-card profile-modal" onClick={e=>e.stopPropagation()}>
                  {loadingProfile && <div className="loading-profile">Loading profile...</div>}
                  {profileData && <ProfileView data={profileData} />}
                </div>
              </div>
            )}

            {/* Fancy alert */}
            {alert && (
              <div className="fancy-alert-backdrop" onClick={()=>setAlert(null)}>
                <div className="fancy-alert" onClick={e=>e.stopPropagation()}>
                  <h3>{alert.title}</h3>
                  <p>{alert.message}</p>
                  <div className="actions">
                    <button className="btn ghost" onClick={()=>setAlert(null)}>Close</button>
                    <button className="btn primary" onClick={()=>setAlert(null)}>OK</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        )
      }

      function ProfileView({ data }) {
        if (data.failed) {
          return (
            <div className="profile-body">
              {data.fallbackName && <div className="profile-name">{data.fallbackName}</div>}
              {data.discord_user && data.discord_user.id && <div style={{marginTop: 6, color:'var(--muted)'}}>User ID: {data.discord_user.id}</div>}
              <p style={{color: 'var(--muted)', marginTop: '12px'}}>Could not fetch user profile.</p>
            </div>
          )
        }

        const { discord_user, discord_status, activities, spotify, badges } = data;
        const bannerUrl = discord_user.banner;
        const avatarUrl = discord_user.avatar || 'https://cdn.discordapp.com/embed/avatars/0.png';

        // The API returns badge names like "HOUSE_BRILLIANCE".
        // The badgeInfo object has keys like "House_Brilliance".
        // We find matching keys by uppercasing the badgeInfo keys.
        const userBadges = Object.keys(badgeInfo).filter(key => badges.includes(key.toUpperCase()));

        return (
          <div>
            <div className="profile-header" style={{ backgroundColor: discord_user.banner_color, backgroundImage: bannerUrl ? `url(${bannerUrl})` : undefined }}></div>
            <div className="profile-avatar-wrapper">
              <img className="profile-avatar" src={avatarUrl} alt="avatar" />
            </div>
            <div className="profile-body">
              <div className="profile-name">
                {discord_user.display_name}
              </div>
              <div style={{ color: 'var(--muted)', marginTop: '2px', marginBottom: '12px' }}>
                {discord_user.username}
                {discord_user.discriminator !== "0" && <span className="profile-discriminator">#{discord_user.discriminator}</span>}
              </div>

              <div style={{ borderTop: '1px solid rgba(255,255,255,0.04)', margin: '12px 0' }}></div>
              
              <div style={{ fontSize: '13px', color: 'var(--muted)', marginBottom: '12px' }}>
                User ID: {discord_user.id}
              </div>
              
              <div className="profile-badges">
                {userBadges.map(badge => (
                  <img key={badge} src={badgeInfo[badge].icon} title={badgeInfo[badge].label} className="profile-badge" />
                ))}
              </div>

              <div className="profile-status">
                <div className={`status-dot ${discord_status}`}></div>
                <span>{(discord_status || 'offline').charAt(0).toUpperCase() + (discord_status || 'offline').slice(1)}</span>
              </div>
              
              <div className="profile-activities">
                {(activities || []).filter(a => a.type !== 4).map(activity => (
                  <div key={activity.id || activity.name} className="activity">
                    {activity.assets && activity.assets.large_image && 
                      <img src={`https://cdn.discordapp.com/app-assets/${activity.application_id}/${activity.assets.large_image}.png`} alt="" />
                    }
                    <div className="activity-details">
                      <strong>{activity.name}</strong>
                      <span>{activity.details}</span>
                      <span>{activity.state}</span>
                    </div>
                  </div>
                ))}
                {spotify && (
                   <div className="activity">
                    <img src={spotify.album_art_url} alt="album art" />
                    <div className="activity-details">
                      <strong>{spotify.song}</strong>
                      <span>by {spotify.artist}</span>
                      <span>on {spotify.album}</span>
                    </div>
                  </div>
                )}
              </div>
            </div>
          </div>
        )
      }

      ReactDOM.render(<App />, document.getElementById('root'));
    </script>
  </body>
</html>
